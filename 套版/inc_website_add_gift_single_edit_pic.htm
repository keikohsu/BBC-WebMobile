<style>
    /* --- 公用 --- */
    .pic-org-text-restrict {
        padding: 10px;
        display: block;
        background: var(--pic-light-orange-5);
        color: var(--pic-orange);
        font-size: 12px;
        line-height: 16px;
    }

    .pic-org-text-restrict > p {
        font-size: 16px;
        line-height: 20px;
    }

    .admweb-v2-SearchHeartBtn {
        border-radius: 6px;
    }

    .admweb-v2-SearchHeartBtn a {
        font-size: 12px;
        line-height: 20px;
        padding: 10px;
        color: #fff;
    }

    /* --- 公用end --- */

    /* --- 針對單頁css_page_add_gift_single_edit_pic Start ---  */
    /* page_add_gift_single_edit_pic */
    .admweb-v2-add-gift-single-edit-pic .admweb-v2-EventMerchandise label {
        width: 78px;
    }

    .admweb-v2-add-gift-single-edit-pic .admweb-v2-EventMerchandise .pic-text-lnput {
        width: 100%;
        margin-left: 12px;
    }

    .admweb-v2-add-gift-single-edit-pic .admweb-v2-eventTime .admweb-v2-input-date-content_title {
        font-size: 14px;
    }

    /* page_add_gift_single_edit_pic批次設定 */
    .admweb-v2-add-gift-single-edit-pic .admweb-v2-blacklist-form .admweb-v2-EventMerchandise-btn {
        width: auto;
    }

    .admweb-v2-add-gift-single-edit-pic .admweb-v2-blacklist-form .admweb-v2-EventMerchandise-select-box {
        width: 100%;
        margin-right: 58px;
    }

    .admweb-v2-add-gift-single-edit-pic .admweb-v2-blacklist-form .admweb-v2-EventMerchandise label {
        width: 68px;
        text-align: left;
    }

    /* --- 針對單頁css_page_add_gift_single_edit_pic End ---  */
</style>

<div class="pic-default pic-flex admweb-v2-orderlist">
    <!-- 左側選單 Start -->
    <div class="admweb-v2-seller-front-left-box">
        {{include file="admweb_2/admweb.main_menu.htm"}}
    </div>
    <!-- 左側選單 End -->

    <!-- 右側內容 Start -->
    <div class="admweb-v2-adjustment admweb-v2-add-gift-single-edit-pic">
        <form id="formPmkt" name="formPmkt" action="" method="post" onsubmit="return _CS_checkAdd(this);">
            <!------------------------------------ 活動基本設定 Start -------------------------------------->
            <div class="admweb-v2-settings-frame pic-margin-10">
                <div class="admweb-v2-NewProduct-title">
                    <h2 class="admweb-v2-SettingsTitle"><i class="icons-line icon-line-paper-text"></i>活動基本設定</h2>
                </div>

                <!-- 活動設定 -->
                <ul class="admweb-v2-outside-white-box">
                    <li class="admweb-v2-edit-name">
                        <p><span class="pic-text-red">*</span>活動類型</p>
                    </li>
                    <li class="admweb-v2-content-enter admweb-v2-settings-frame-RadioBox">
                        {{if $m_arrProductMarketing[0].pmkt_type!=1 || $smarty.get.add_pmkt}}
                        <div class="admweb-v2-radio-green-box">
                            <label class="admweb-v2-label-green" for="radioId1">
                                <input class="admweb-v2-radio-green" type="radio" id="radioId1" name="pmkt_type" value="2"
                                       {{if $m_arrProductMarketing[0].pmkt_type!=1}}checked{{/if}}>
                                <div class="admweb-v2-label-check-green"></div>
                                加購
                            </label>
                        </div>
                        {{/if}}
                        {{if $m_arrProductMarketing[0].pmkt_type==1 || $smarty.get.add_pmkt}}
                        <div class="admweb-v2-radio-green-box">
                            <label class="admweb-v2-label-green" for="radioId2">
                                <input class="admweb-v2-radio-green" type="radio" id="radioId2" name="pmkt_type" value="1"
                                       {{if $m_arrProductMarketing[0].pmkt_type==1}}checked{{/if}}/>
                                <div class="admweb-v2-label-check-green"></div>
                                加贈
                            </label>
                        </div>
                        {{/if}}
                    </li>
                </ul>

                <!-- 活動名稱-->
                <ul class="admweb-v2-outside-white-box">
                    <li class="admweb-v2-edit-name">
                        <p><span class="pic-text-red">*</span>活動名稱</p>
                        <span id="pmkt_title-length" class="pic-quantity">0/20</span>
                    </li>
                    <li class="admweb-v2-content-enter">
                        <input type="text" class="pic-text-lnput pic-lnput-enter" id="pmkt_title" name="pmkt_title"
                               maxlength="20" placeholder="請輸入活動名稱" value="{{$m_arrProductMarketing[0].pmkt_title}}">
                        <p class="pic-red-text-restrict" id="text_over" style="display: none;">字數不能超過20個字</p>
                        <p class="pic-text-warn">※請勿使用&()=;’”<>\等特殊符號，避免提交後賣場無法使用。</p>
                    </li>
                </ul>

                <!-- 活動時間-->
                <ul class="admweb-v2-outside-white-box admweb-v2-eventTime">
                    <li class="admweb-v2-edit-name">
                        <p><span class="pic-text-red">*</span>活動時間</p>
                    </li>
                    <li class="admweb-v2-content-enter admweb-v2-input-date pic-margin-b5">
                        <div class="admweb-v2-input-date-content">
                            <div class="admweb-v2-input-date-content_title">起始時間</div>
                            <span class="admweb-v2-DateBox iopen-icon-date pic-margin-r5">
                            <input id="pmkt_time_start_d" class="pic-text-lnput datepicker" type="text"
                                   value="{{$m_arrProductMarketing[0].pmkt_time_start|date_format:'%Y/%m/%d'}}"
                                   onchange="setTime('pmkt_time_start')" readonly>
                            </span>
                            <select class="pic-text-lnput iopen-text-lnput-style" id="pmkt_time_start_h"
                                    onchange="setTime('pmkt_time_start')">
                                {{section name=i loop=24 start=0}}
                                <option {{if $m_arrProductMarketing[0].pmkt_time_start|date_format:'%H'==$smarty.section.i.index|string_format:'%02s'}}selected{{/if}}>
                                {{$smarty.section.i.index|string_format:"%02s"}}</option>
                                {{/section}}
                            </select>
                            <div class="admweb-v2-DateNotation">:</div>
                            <select class="pic-text-lnput iopen-text-lnput-style" id="pmkt_time_start_m"
                                    onchange="setTime('pmkt_time_start')">
                                {{section name=i loop=60 start=0}}
                                <option {{if $m_arrProductMarketing[0].pmkt_time_start|date_format:'%M'==$smarty.section.i.index|string_format:'%02s'}}selected{{/if}}>
                                {{$smarty.section.i.index|string_format:"%02s"}}</option>
                                {{/section}}
                            </select>
                            <div class="admweb-v2-DateNotation">-</div>
                            <div class="admweb-v2-input-date-content_title">結束時間</div>
                            <span class="admweb-v2-DateBox iopen-icon-date pic-margin-r5">
                            <input id="pmkt_time_end_d" class="pic-text-lnput datepicker" type="text"
                                   value="{{$m_arrProductMarketing[0].pmkt_time_end|date_format:'%Y/%m/%d'}}"
                                   onchange="setTime('pmkt_time_end')" readonly>
                            </span>
                            <select class="pic-text-lnput iopen-text-lnput-style" id="pmkt_time_end_h"
                                    onchange="setTime('pmkt_time_end')">
                                {{section name=i loop=24 start=0}}
                                <option {{if $m_arrProductMarketing[0].pmkt_time_end|date_format:'%H'==$smarty.section.i.index|string_format:'%02s'}}selected{{/if}}>
                                {{$smarty.section.i.index|string_format:"%02s"}}</option>
                                {{/section}}
                            </select>
                            <div class="admweb-v2-DateNotation">:</div>
                            <select class="pic-text-lnput iopen-text-lnput-style" id="pmkt_time_end_m"
                                    onchange="setTime('pmkt_time_end')">
                                {{section name=i loop=60 start=0}}
                                <option {{if $m_arrProductMarketing[0].pmkt_time_end|date_format:'%M'==$smarty.section.i.index|string_format:'%02s'}}selected{{/if}}>
                                {{$smarty.section.i.index|string_format:"%02s"}}</option>
                                {{/section}}
                            </select>
                        </div>
                    </li>
                </ul>
                <input type="hidden" id="pmkt_time_start" name="pmkt_time_start" value="{{$m_arrProductMarketing[0].pmkt_time_start}}">
                <input type="hidden" id="pmkt_time_end" name="pmkt_time_end" value="{{$m_arrProductMarketing[0].pmkt_time_end}}">

                <!-- 狀態 -->
                <ul class="admweb-v2-outside-white-box">
                    <li class="admweb-v2-edit-name">
                        <p><span class="pic-text-red">*</span>狀態</p>
                    </li>
                    <li class="admweb-v2-content-enter admweb-v2-settings-frame-RadioBox">
                        <div class="admweb-v2-radio-green-box">
                            <label class="admweb-v2-label-green" for="status_1">
                                <input class="admweb-v2-radio-green" type="radio" id="status_1" name="status"
                                       {{if $m_arrProductMarketing[0].status!=0}}checked{{/if}} value="1"/>
                                <div class="admweb-v2-label-check-green"></div>
                                有效
                            </label>
                        </div>

                        <div class="admweb-v2-radio-green-box">
                            <label class="admweb-v2-label-green" for="status_0">
                                <input class="admweb-v2-radio-green" type="radio" id="status_0" name="status"
                                       {{if $m_arrProductMarketing[0].status==0}}checked{{/if}} value="0"/>
                                <div class="admweb-v2-label-check-green"></div>
                                無效
                            </label>
                        </div>
                    </li>
                </ul>
            </div>
            <!------------------------------------ 活動基本設定 End -------------------------------------->
            <!------------------------------------ 主商品、加贈商品、加購商品 Start -------------------------------------->
            <!-- ------------------------- 主商品_start ----------------- -->
            <div class="admweb-v2-settings-frame pic-margin-10" id="main_prod_list">
                <div class="admweb-v2-NewProduct-title">
                    <h2 class="admweb-v2-SettingsTitle">
                        <i class="icons-line icon-line-box-product"></i><text id="main_item_count">主商品(0/100)</text>
                    </h2>
                    <a class="admweb-v2-I-Btn pic-BgText-color-green pic-margin-r5" onclick="WindowOpen('main')">
                        <i class="icons-line icon-line-add"></i>選擇商品
                    </a>
                </div>
                <div class="admweb-v2-NewProduct-title">
                    <p class="pic-text-warn">
                        ※ 行銷活動需選擇"同溫層商品"販售，以"主商品"中多數有效（已上架/非隱藏商品/未刪除/非團購/非拼團）商品溫層為活動溫層。
                        <br/>
                        ※ 不同溫層、同商品數量時，優先序為：常溫、冷藏、冷凍。
                    </p>
                </div>

                {{if $m_arrProductMarketing|@count>0 && !$smarty.get.add_pmkt}}
                {{foreach from=$m_arrProductMarketing item=pmkt_prod}}
                <div class="admweb-v2-EventMerchandise-ProductBox main_product_box ori" id="main_product_box_{{$pmkt_prod.prod_uid}}"
                    {{if $pmkt_prod.text_warn}}unav{{else}}avail{{/if}} type="{{$pmkt_prod.prod_type}}">
                    <div class="admweb-v2-EventMerchandise-state pic_warn_main pic_warn_mask" {{if !$pmkt_prod.text_warn}}style='display:none;'{{/if}}>
                        <h2>商品不適用此行銷活動</h2>
                        <p class="pic-text-warn">
                            {{if $pmkt_prod.text_warn}}{{$pmkt_prod.text_warn}}{{else}}行銷活動需選擇"同溫層商品"販售{{/if}}
                        </p>
                        <div class="admweb-v2-icon-right">
                            <a href="javascript:delete_product('{{$pmkt_prod.prod_uid}}', 'main')" class="iopen-icon-black-delete"></a>
                        </div>
                    </div>

                    <input type="hidden" name="main_prod_uid[]" value="{{$pmkt_prod.prod_uid}}">
                    <div class="admweb-v2-checkbox-name pic-margin-r10"></div>
                    <img class="pic-margin-r10" src="{{$pmkt_prod.prod_file}}">
                    <div class="admweb-v2-product-name">
                        {{if $pmkt_prod.prod_type == 3}}
                        <span class="pic-sort-color-orange pic-sort-frame"><i class="icons-line icon-line-General"></i>常溫</span>
                        {{elseif $pmkt_prod.prod_type == 10}}
                        <span class="pic-sort-color-light-green pic-sort-frame"><i class="icons-line icon-line-Fridge"></i>冷藏</span>
                        {{elseif $pmkt_prod.prod_type == 11}}
                        <span class="pic-sort-color-blue pic-sort-frame"><i class="icons-line icon-line-Freezing"></i>冷凍</span>
                        {{/if}}                        
                        <h2>{{$pmkt_prod.prod_name}}</h2>
                        <div class="admweb-v2-product-detail">
                            <span>規格：{{if $pmkt_prod.prod_spec_str}}{{$pmkt_prod.prod_spec_str}}{{else}} - {{/if}}</span>
                            <span>${{$pmkt_prod.prod_selling_price}}</span>
                        </div>
                    </div>
                    <div class="admweb-v2-icon-right">
                        <a href="javascript:delete_product('{{$pmkt_prod.prod_uid}}', 'main')" class="iopen-icon-black-delete"></a>
                    </div>
                </div>
                {{/foreach}}
                {{/if}}
                <div class="admweb-v2-NoData" {{if $m_arrProductMarketing|@count > 0 && !$smarty.get.add_pmkt}}style='display:none;'{{/if}}>
                    <div class="admweb-v2-img-BlacklistNoData"></div>
                    <span>沒有任何商品資料</span>
                </div>
            </div>
            <!-- ----------------- 主商品_end ----------------- -->

            <!-- ----------------- 加購贈商品_start ----------------- -->
            <div class="admweb-v2-settings-frame pic-margin-10" id="sub_prod_list">
                <div class="admweb-v2-NewProduct-title">
                    <h2 class="admweb-v2-SettingsTitle">
                        <i class="icons-line icon-line-box-product"></i><text id="sub_item_count">加購商品(0/100)</text>
                    </h2>
                    <a class="admweb-v2-I-Btn pic-BgText-color-green pic-margin-r5" onclick="WindowOpen('sub')">
                        <i class="icons-line icon-line-add"></i>選擇商品
                    </a>
                </div>
                <div class="admweb-v2-NewProduct-title">
                    <p class="pic-text-warn">
                        ※ 加贈加購商品需與主商品同溫層。
                    </p>
                </div>
    
                <!-- 批次設定 -->
                <div class="admweb-v2-blacklist-form batch_edit_box pmkt_type2">
                    <!-- 商品搜尋表單 -->
                    <div class="pic-bg-green-5 admweb-v2-orderlist__form js-orderlist__form" id="search_form">
                        <div class="admweb-v2-EventMerchandise-form">
                            <div class="js-orderlist__form-head_search"></div>
                            <!-- 進階條件 -->
                            <div>
                                <span>批次設定</span>
                                <div class="admweb-v2-EventMerchandise">
                                    <div class="admweb-v2-EventMerchandise-select-box">
                                        <label>加購價</label>
                                        <input name="batch_price" type="text" placeholder="請輸入金額"
                                               class="pic-text-lnput pic-lnput-enter price_box">
                                    </div>
                                    <div class="admweb-v2-EventMerchandise-btn">
                                        <button type="button" class="pic-BgText-color-green admweb-v2-form-TickBtn"
                                                style="cursor:pointer;" onclick="batch_set_price()">
                                            <i class="icons-line icon-line-tick"></i>
                                            全部套用
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" name="nav" value="all">
                    </div>
                    <button class="pic-text-gray-30 pic-bg-green-5 admweb-v2-orderlist__form-toggle-btn" type="button"
                        id="js-orderlist__form-toggle--btn">
                        批次更新優惠資訊
                        <i class="icons-line icon-arrow-down-01"></i>
                    </button>
                </div>

                <!-- 全選 -->
                <div class="admweb-v2-orderlist__action-select_all admweb-v2-EventMerchandise-select-all batch_edit_box pmkt_type2">
                    <input type="checkbox" class="admweb-v2-ckbutton-green-checkbox" id="selectAll" value="all">
                    <label for="selectAll" class="admweb-v2-ckbutton-green-label"></label>
                    <span>全選</span>
                </div>

                {{if $m_arrProductMarketingSubProd|@count>0 && !$smarty.get.add_pmkt}}
                {{foreach from=$m_arrProductMarketingSubProd item=pmkt_subprod}}
                <div class="admweb-v2-EventMerchandise-ProductBox sub_product_box ori" id="sub_product_box_{{$pmkt_subprod.prod_uid_per}}"
                    {{if $pmkt_subprod.text_warn}}unav{{else}}avail{{/if}} type="{{$pmkt_subprod.prod_type}}">
                    <div class="admweb-v2-EventMerchandise-state pic_warn_sub pic_warn_mask" {{if !$pmkt_subprod.text_warn}}style='display:none;'{{/if}}>
                        <h2>商品不適用此行銷活動</h2>
                        <p class="pic-text-warn">
                            {{if $pmkt_subprod.text_warn}}{{$pmkt_subprod.text_warn}}{{else}}行銷活動需選擇"同溫層商品"販售{{/if}}
                        </p>
                        <div class="admweb-v2-icon-right">
                            <a href="javascript:delete_product('{{$pmkt_subprod.prod_uid_per}}', 'sub')" class="iopen-icon-black-delete"></a>
                        </div>
                    </div>

                    <input type="hidden" name="sub_prod_uid[]" value="{{$pmkt_subprod.prod_uid_per}}">
                    <div class="admweb-v2-checkbox-name pic-margin-r10">
                        <input type="checkbox" class="admweb-v2-ckbutton-green-checkbox prod_checkbox" id="prod_checkbox_{{$pmkt_subprod.prod_uid_per}}">
                        <label class="admweb-v2-ckbutton-green-label pmkt_type2" for="prod_checkbox_{{$pmkt_subprod.prod_uid_per}}"></label>
                    </div>
                    <img class="pic-margin-r10" src="{{$pmkt_subprod.prod_file}}">
                    <div class="admweb-v2-product-name">
                        {{if $pmkt_subprod.prod_type == 3}}
                        <span class="pic-sort-color-orange pic-sort-frame"><i class="icons-line icon-line-General"></i>常溫</span>
                        {{elseif $pmkt_subprod.prod_type == 10}}
                        <span class="pic-sort-color-light-green pic-sort-frame"><i class="icons-line icon-line-Fridge"></i>冷藏</span>
                        {{elseif $pmkt_subprod.prod_type == 11}}
                        <span class="pic-sort-color-blue pic-sort-frame"><i class="icons-line icon-line-Freezing"></i>冷凍</span>
                        {{/if}}                        
                        <h2>{{$pmkt_subprod.prod_name}}</h2>
                        <div class="admweb-v2-product-detail">
                            <span>規格：{{if $pmkt_subprod.prod_spec_str}}{{$pmkt_subprod.prod_spec_str}}{{else}} - {{/if}}</span>
                            <span>${{$pmkt_subprod.prod_selling_price}}</span>
                        </div>
                    </div>
                    {{if $pmkt_subprod.pmkt_price == 0}}
                    {{assign var=pmkt_price value=$pmkt_subprod.prod_selling_price}}
                    {{else}}
                    {{assign var=pmkt_price value=$pmkt_subprod.pmkt_price}}
                    {{/if}}
                    <div class="admweb-v2-EventMerchandise-select-box pmkt_type2">
                        <label>加購價</label>
                        <input name="pmkt_price[{{$pmkt_subprod.prod_uid_per}}]" type="text" placeholder="請輸入金額"
                               class="pic-text-lnput pic-lnput-enter price_box" value="{{$pmkt_price}}">
                    </div>
                    <div class="admweb-v2-icon-right">
                        <a href="javascript:moveUp('{{$pmkt_subprod.prod_uid_per}}')" class="iopen-icon-black-ArrowsLong-up pmkt_type2" ></a>
                        <a href="javascript:moveDown('{{$pmkt_subprod.prod_uid_per}}')" class="iopen-icon-black-ArrowsLong-down pmkt_type2" ></a>
                        <a href="javascript:delete_product('{{$pmkt_subprod.prod_uid_per}}', 'sub')"
                           class="iopen-icon-black-delete"></a>
                    </div>
                </div>
                {{/foreach}}
                {{/if}}
                <div class="admweb-v2-NoData" {{if $m_arrProductMarketingSubProd|@count>0 && !$smarty.get.add_pmkt}}style='display:none;'{{/if}}>
                    <div class="admweb-v2-img-BlacklistNoData"></div>
                    <span>沒有任何商品資料</span>
                </div>
            </div>
            <!-- ----------------- 加購贈商品_end ----------------- -->
            <!------------------------------------ 主商品、加贈商品、加購商品 Start -------------------------------------->
            <!--新增商品 視窗 -->
            {{include file="admweb_2/add_wmkt_product_pic.htm"}}

            <div class="admweb-v2-orderlist__action admweb-v2-settings-BottomBtn">
                <div class="admweb-v2-I-Btn pic-confirm-box pic-flex-center pic-line-light15">
                    <!-- 灰色 按鈕字 -->
                    <a class="admweb-v2-I-Btn pic-width-100 pic-BgText-color-white-green pic-margin-r5"
                       href="javascript:void(0)" onclick="cancel_btn()">
                       <i class="icons-line icon-line-X"></i>取消
                    </a>
                    <a id="save_button" class="admweb-v2-I-Btn pic-width-100 pic-BgText-color-green pic-margin-l5"
                       href="javascript:void(0);" onclick="$('#formPmkt').submit()">
                        <i class="icons-line icon-line-tick"></i>儲存
                    </a>
                </div>
            </div>
            <input type="hidden" name="myAct" value="">
        </form>
    </div>
</div>

<script>
    var main_sub_prod;  /*{{* 定義任選商品lightbox 的物件 main or sub *}}*/
    var checked_prod_uid;
    var pmkt_checked_puid = {{$arr_product_marketing_prod_uid_list|@json_encode}};
    var pmkt_checked_sub_puid = {{$arr_product_marketing_prod_uid_per_list|@json_encode}};
    var inInput = $("#pmkt_title");
    var init = true;

    function WindowOpen(ms) {
        main_sub_prod = ms;
        $("#admweb-v2-ProductWindow").show()
    }

    function WindowClose() {
        $(".pic-window-bg").hide()
    }

    function searchFormCollapse() {
        const toggleBtn = document.getElementById('js-orderlist__form-toggle--btn');
        const formEle = document.getElementsByClassName('js-orderlist__form')[0];
        const formHeadEle = document.getElementsByClassName('js-orderlist__form-head_search')[0];
        const defaultHeight = formHeadEle.clientHeight;
        const wholeHeight = formEle.clientHeight;
        formEle.style.height = `${defaultHeight}px`;
        toggleBtn.addEventListener('click', () => {
            //當前為收合
            if (formEle.style.height === `${defaultHeight}px`) {
                formEle.style.height = `${wholeHeight}px`;
                toggleBtn.innerHTML = '批次更新優惠資訊<i class="icons-line icon-arrow-top-01"></i>';
                formHeadEle.style.gridTemplateColumns = 'auto 3fr';
            } else {
                ///當前為展開
                formEle.style.height = `${defaultHeight}px`;
                toggleBtn.innerHTML = '批次更新優惠資訊<i class="icons-line icon-arrow-down-01"></i>';
                formHeadEle.style.gridTemplateColumns = 'auto 1fr 84px';
            }
        });
    }

    $(document).ready(function(){
        searchFormCollapse();

        if('{{$smarty.get.add_pmkt}}'=='1'){
            $("input[name='myAct']").val('COMMAND_ADD');
        } else {
            $("input[name='myAct']").val('COMMAND_EDIT');
        }

        inInput.on('input', function (){
            inputLength($(this));
        });
        inputLength(inInput);

        $(".datepicker").datepicker({
            dateFormat: 'yy/mm/dd',
            changeYear: true,
            changeMonth: true,
            monthNamesShort: ["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],
            dayNamesMin: ['日','一','二','三','四','五','六'],
            minDate: null,
            yearRange: '2023:2050',
        }).attr('size', 10);

        $("#pmkt_time_start_d").datepicker("option","onClose",function(dateText,inst){
            $("#pmkt_time_end_d").datepicker("option","minDate",dateText);
        });

        $("#pmkt_time_end_d").datepicker("option","onClose",function(dateText,inst){
            $("#pmkt_time_start_d").datepicker("option","maxDate",dateText);
        });

        $("input[name='pmkt_type']").on('change', function (){
            setButtonStatus();
            setProdCount();
        })

        $("#selectAll").on('change', function (){
            $(".prod_checkbox").prop('checked', $("#selectAll").prop('checked'));
        })

        $("#formPmkt").on('change', '.prod_checkbox', function (){
            check_select_all()
        })

        $("#formPmkt").on('keyup', '.price_box', function (){
            setButtonStatus()
        })

        /*{{* 活動包含無效商品時 禁止轉為有效活動 *}}*/
        $('input[name=status][value=1]').on('click',function(e){
            if(!check_pmkt_status(true))
            e.preventDefault();
        });

        $('#formPmkt').on('input', 'input.price_box', function () {
            let v = $(this).val();
            let str = v.replace(/[^\d]/g,'')

            if(str.length!=0) $(this).val(parseInt(str));
            else $(this).val('')
        });

        /*{{* 選擇商品 *}}*/
        /*{{* checked_puid => 活動的主商品 或 加贈加購品 *}}*/
        /*{{* checked_prod_uid => lightbox中選擇的商品 *}}*/
        const intersectionObserver = new IntersectionObserver((entries) => {
            if(entries[0].intersectionRatio == 1) { // 開啟視窗
                init = false;
                if (main_sub_prod == 'main') {
                    checked_puid = pmkt_checked_puid;
                } else {
                    checked_puid = pmkt_checked_sub_puid;
                }

                checked_prod_uid = new Array();
                $('input[name="prod_uid"]').prop('checked',false);
                $(`.${main_sub_prod}_product_box[avail]`).each(function (){
                    let puid = $(this).find(`input[name="${main_sub_prod}_prod_uid[]"]`).val()
                    check_puid_in_lightbox(puid)
                    checked_prod_uid.push(puid)
                });

                sessionStorage.setItem('checked_prod_uid', JSON.stringify(checked_prod_uid));
            }

            if(entries[0].intersectionRatio <= 0 && !init){ // 關閉視窗
                if(sessionStorage.getItem('checked_prod_uid')!=null){
                    checked_prod_uid = JSON.parse(sessionStorage.getItem('checked_prod_uid'));
                }

                if(checked_prod_uid.length + $(`[unav] .pic_warn_${main_sub_prod}:visible`).length > 100){
                    alert('超過總選擇商品數量上限100個，請重新選取').done(function(){
                        open_add_product_box();
                    });
                    return false;
                } else {
                    let avail_ptype = get_avail_ptype();
                    let arr_WMKT_ptype = {{$arr_WMKT_prod_type|@json_encode}};

                    checked_prod_uid.forEach(ele => {
                        if (checked_puid.indexOf(ele) < 0) {
                            if(avail_ptype.type==0 && main_sub_prod=='main') 
                                avail_ptype = arr_WMKT_ptype[obj_wmkt_prod[ele].prod_type];

                            if(obj_wmkt_prod[ele].prod_type != avail_ptype.type && 
                                !(avail_ptype.type == 0 && $('#main_prod_list [avail]').length == 0)){
                                check_puid_in_lightbox(ele, false);
                                let avail_type_str = `目前活動溫層：${avail_ptype.str}`;
                                alert(`${avail_type_str}。<br/>請移除其他溫層商品！<br/><br/>若需變更溫層，請先刪除目前溫層商品。請參考紅字提示規則。`);
                            }else{
                                checked_puid.push(ele);
                                add_product(obj_wmkt_prod[ele])
                            }
                        }
                    });

                    $(checked_puid).not(checked_prod_uid).toArray().forEach(p_uid => {
                        if ($(`#${main_sub_prod}_product_box_${p_uid}[avail]`).length > 0) {
                            delete_product_unit(p_uid, main_sub_prod);
                        }
                    })
                }
            }
        });
        intersectionObserver.observe(document.querySelector('#admweb-v2-ProductWindow'));
        /*{{* 選擇商品END *}}*/

        setButtonStatus();
        setProdCount();
    });

    //*** 內容長度呈現 ******
    function inputLength(ele){
        var length = $(ele).val().length;
        var maxlength = $(ele).attr("maxlength");
        var div_id = $(ele).attr("name")+"-length";
        document.getElementById(div_id).innerText = length + "/" + maxlength;
        $('#pmkt_title').val($(ele).val());
        if(length>=20) $('#text_over').show();
        else $('#text_over').hide();
        setButtonStatus();
    }

    function setTime(id){
        var date = document.getElementById(id + "_d").value.replace(/\//g, '-');
        var hour = document.getElementById(id + "_h").value;
        var min = document.getElementById(id + "_m").value;
        document.getElementById(id).value = date + ' ' + hour + ':' + min + ':00';
    }

    function batch_set_price() {
        var price = document.querySelector("input[name='batch_price']").value;

        if(price == '') alert('請輸入批次設定價格');
        else{
            let ta = $(".prod_checkbox:checked");
            if(ta.length == 0) alert('請勾選商品');
            else{
                $(".prod_checkbox:checked").parents('.sub_product_box').find(".price_box").val(price);
                setButtonStatus()
            }
        }
    }

    function add_product(prod){
        var add_prod_html, prod_label;
        var prod_file = prod.prod_file ? `{{$m_arrSystem.uploads_product_url}}${prod.prod_file}` : '{{$sys_arrWebsite.website_url}}images/skm_nopic.jpg';

        if(prod.prod_type == 3) prod_label = `<span class="pic-sort-color-orange pic-sort-frame"><i class="icons-line icon-line-General"></i>常溫</span>`;
        else if(prod.prod_type == 10) prod_label = `<span class="pic-sort-color-light-green pic-sort-frame"><i class="icons-line icon-line-Fridge"></i>冷藏</span>`;
        else prod_label = `<span class="pic-sort-color-blue pic-sort-frame"><i class="icons-line icon-line-Freezing"></i>冷凍</span>`;

        let mask_htm = `<div class="admweb-v2-EventMerchandise-state pic_warn_${main_sub_prod} pic_warn_mask" style='display:none;'>
                            <h2>商品不適用此行銷活動</h2>
                            <p class="pic-text-warn">行銷活動需選擇"同溫層商品"販售</p>
                            <div class="admweb-v2-icon-right">
                                <a href="javascript:delete_product('${prod.prod_uid}', '${main_sub_prod}')" class="iopen-icon-black-delete"></a>
                            </div>
                        </div>`;

        let prod_basic_htm = `<img class="pic-margin-r10" src="${prod_file}">
                              <div class="admweb-v2-product-name">
                                  ${prod_label}
                                  <h2>${prod.prod_name}</h2>
                                  <div class="admweb-v2-product-detail">
                                      <span>規格：${prod.prod_spec_cus}</span>
                                      <span>$${prod.prod_selling_price}</span>
                                  </div>
                              </div>`;

        if(main_sub_prod == 'main') {
            add_prod_html = `
            <div class="admweb-v2-EventMerchandise-ProductBox main_product_box ori" id="main_product_box_${prod.prod_uid}"
                avail type="${prod.prod_type}">
                ${mask_htm}
                <input type="hidden" name="main_prod_uid[]" value="${prod.prod_uid}">
                <div class="admweb-v2-checkbox-name pic-margin-r10"></div>
                ${prod_basic_htm}
                <div class="admweb-v2-icon-right">
                    <a href="javascript:delete_product('${prod.prod_uid}', 'main')" class="iopen-icon-black-delete"></a>
                </div>
            </div>`;
        } else {
            add_prod_html = `
            <div class="admweb-v2-EventMerchandise-ProductBox sub_product_box ori" id="sub_product_box_${prod.prod_uid}"
                avail type="${prod.prod_type}">
                ${mask_htm}
                <input type="hidden" name="sub_prod_uid[]" value="${prod.prod_uid}">
                <div class="admweb-v2-checkbox-name pic-margin-r10">
                    <input type="checkbox" class="admweb-v2-ckbutton-green-checkbox prod_checkbox" id="prod_checkbox_${prod.prod_uid}">
                    <label class="admweb-v2-ckbutton-green-label pmkt_type2" for="prod_checkbox_${prod.prod_uid}"></label>
                </div>
                ${prod_basic_htm}
                <div class="admweb-v2-EventMerchandise-select-box pmkt_type2">
                    <label>加購價</label>
                    <input name="pmkt_price[${prod.prod_uid}]" type="text" placeholder="請輸入金額"
                            class="pic-text-lnput pic-lnput-enter price_box" value="${prod.prod_selling_price}">
                </div>
                <div class="admweb-v2-icon-right">
                    <a href="javascript:moveUp('${prod.prod_uid}')" class="iopen-icon-black-ArrowsLong-up pmkt_type2" ></a>
                    <a href="javascript:moveDown('${prod.prod_uid}')" class="iopen-icon-black-ArrowsLong-down pmkt_type2" ></a>
                    <a href="javascript:delete_product('${prod.prod_uid}', 'sub')" class="iopen-icon-black-delete"></a>
                </div>
            </div>`;
        }

        document.getElementById(main_sub_prod + "_prod_list").insertAdjacentHTML('beforeend', add_prod_html);

        setButtonStatus();
        setProdCount();
    }

    function delete_product(prod_uid, del_main_sub){
        if ('{{$m_arrSystem.custom_dialog}}' == '1') {
            confirm("是否確認刪除此商品?").done(function(){
                delete_product_unit(prod_uid, del_main_sub)
            })
        } else {
            if (confirm("是否確認刪除此商品?")) {
                delete_product_unit(prod_uid, del_main_sub)
            }
        }
    }

    function delete_product_unit(prod_uid, del_main_sub){
        // del_main_sub => main or sub
        if($('#'+del_main_sub+'_product_box_'+prod_uid).hasClass('ori')) {
            var input = document.createElement("input");
            input.setAttribute("type", "hidden");
            input.setAttribute("name", "delete_" + del_main_sub + "_prod[]");
            input.setAttribute("value", prod_uid);

            var prodList = document.getElementById(del_main_sub + "_prod_list");
            prodList.insertBefore(input, prodList.firstChild);
        }

        var element = document.getElementById(del_main_sub+"_product_box_"+prod_uid);
        if (element) {
            element.parentNode.removeChild(element);
        }

        if(del_main_sub == 'main'){
            pmkt_checked_puid.splice(pmkt_checked_puid.indexOf(prod_uid), 1);
        } else if (del_main_sub == 'sub') {
            pmkt_checked_sub_puid.splice(pmkt_checked_sub_puid.indexOf(prod_uid), 1);
        }

        setButtonStatus();
        setProdCount();
    }

//----------------------------------------------------------------------------------------------------------------------

    /*{{* 顯示選擇活動商品數及溫層 *}}*/
    function setProdCount() {
        let pmkt_type = $("input[name='pmkt_type']:checked").val();
        let avail_ptype = get_avail_ptype();
        let main_p_cnt = $(".main_product_box").length;
        let sub_p_cnt = $(".sub_product_box").length;

        if(main_p_cnt == 0) $('#main_prod_list .admweb-v2-NoData').show();
        else $('#main_prod_list .admweb-v2-NoData').hide();

        $("#main_item_count").html(`主商品(${main_p_cnt}/100)<span>目前活動溫層：${avail_ptype.str}</span>`);

        if(sub_p_cnt == 0){
            $('#sub_prod_list .admweb-v2-NoData').show();
            $('#sub_prod_list .pmkt_type2').hide();
        }else{
            $('#sub_prod_list .admweb-v2-NoData').hide();
            if(pmkt_type == '2') $('#sub_prod_list .pmkt_type2').show();
            else $('#sub_prod_list .pmkt_type2').hide();
        }


        let act_str = (pmkt_type == '2')?'購':'贈';
        let clean = `加${act_str}商品(${sub_p_cnt}/100)<span>目前活動溫層：${avail_ptype.str}</span>`;
        $("#sub_item_count").html(clean);
        
        check_select_all();        
        mask_unavail_ptype(avail_ptype.type);
        check_pmkt_status(false)
    }

    /*{{* 非活動溫層商品加遮罩 *}}*/
    function mask_unavail_ptype(avail_type){
        let types = [3,10,11];

        if(avail_type == 0 && $('#main_prod_list [avail]').length == 0)
            $(`div.admweb-v2-EventMerchandise-ProductBox[avail] .pic_warn_mask`).hide();
        else{
            $.each(types, function (idx,ele) {
                if(ele!=avail_type) $(`div.admweb-v2-EventMerchandise-ProductBox[type=${ele}][avail] .pic_warn_mask`).show();
                else $(`div.admweb-v2-EventMerchandise-ProductBox[type=${ele}][avail] .pic_warn_mask`).hide();
            });        
        }
    }

    /*{{* 動態判別目前活動多數有效商品溫層 => 以【主商品】爲準 *}}*/
    function get_avail_ptype(){
        let arr_WMKT_ptype = {{$arr_WMKT_prod_type|@json_encode}};

        $.each(pmkt_checked_puid , function (idx, ele) { 
            if(obj_wmkt_prod[ele]!==undefined) arr_WMKT_ptype[obj_wmkt_prod[ele].prod_type]['cnt'] += 1;
        });

        let qty = 0;
        let avail_ptype = arr_WMKT_ptype[0];
        $.each(arr_WMKT_ptype, function (idx, ele) { 
            if(ele.cnt > qty){
                qty = ele.cnt;
                avail_ptype = ele;
            }
        });

        return avail_ptype;
    }

    function check_pmkt_status(hint){
        if($('.pic_warn_mask:visible').length==0) return true;
        else{
            $('input[name=status][value=0]').click();
            if(hint) alert('變更活動狀態為有效前，<br/>請先選定主商品與加贈加購商品，<br/>並刪除不適用此行銷活動商品。');
            return false;
        }
    }

    function check_select_all() {
        if($('.prod_checkbox:checked').length == $('.prod_checkbox').length) $("#selectAll").prop('checked', true)
        else $("#selectAll").prop('checked', false)
    }

    function setButtonStatus(){
        let status = '1';
        if($("#pmkt_money_start").val() == '') status = '0';
        if($("#pmkt_title").val() == '') status = '0';
        if($(".main_product_box").length == '') status = '0';
        if($(".sub_product_box").length == '') status = '0';
        if($("input[name='pmkt_type']:checked").val()=='2'){
            $(".sub_product_box .price_box").each(function (){
                if($(this).val() == ''){
                    status = '0';
                }
            })
        }

        if(status == '1') {
            $("#save_button").addClass('pic-BgText-color-green').removeClass('pic-BgText-color-gray').css('pointer-events', '');
        } else {
            $("#save_button").addClass('pic-BgText-color-gray').removeClass('pic-BgText-color-green').css('pointer-events', 'none');
        }
    }

    function moveUp(prod_uid){
        var p_item = $("#sub_product_box_"+prod_uid)
        p_item.prev('.sub_product_box').before(p_item);
    }

    function moveDown(prod_uid){
        var p_item = $("#sub_product_box_"+prod_uid)
        p_item.next('.sub_product_box').after(p_item);
    }

    function _CS_checkAdd(_this){
        if(_this.pmkt_title.value.search(/[\\\/'"&()=;<>]/)>0){
            alert('請確認活動名稱中是否有特殊符號。')
            return false;
        }

        let check_repeat = 0;
        $.ajax({
            url:'',
            type:'POST',
            dataType:'json',
            async:false,
            data:{
                myAct:'CHECK_TITLE_REPEAT',
                new_title:_this.pmkt_title.value },
            success: function (r){
                if(r == 'repeat'){
                    check_repeat = 1;
                }
            }
        })
        if(check_repeat){
            alert('已有相同活動名稱，請重新編輯！')
            return false;
        }

        $("#save_button").addClass('pic-BgText-color-gray').removeClass('pic-BgText-color-green').css('pointer-events', 'none');
    }

    function cancel_btn(){
        confirm('您尚未儲存目前編輯之內容<br>，請問是否確認取消編輯？').done(function (){
            window.location.href = encodeURI('{{$m_backURL}}'); //Checkmarkx Client DOM XSS 
        });
    }
</script>